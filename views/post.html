<!DOCTYPE html>
<html lang="en">
   <head>
      <meta charset="utf-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
	  <meta name="viewport" content="width=device-width, initial-scale=1">
	  <meta name="google-signin-scope" content="profile email">	  
	  <meta name="google-signin-client_id" content="94568658962-oqp52u4s7kk7nl45j06hgppiisc34olq.apps.googleusercontent.com">  
      <title>Chaddon</title>
      <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
      <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
      <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
      <!-- Leave those next 4 lines if you care about users using IE8 -->
      <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
	  <![endif]-->
	  <script src="https://apis.google.com/js/platform.js" async defer></script>
      <link rel="stylesheet" href="stylesheets/style.css">
   </head>
   <body>
      <nav class="navbar navbar-inverse">
         <div class="container-fluid">
            <div class="navbar-header">
               <a class="navbar-brand" href="#"><img src="./images/chaddon_logo.jpeg" alt="Chaddon Logo" height="28" width="28">
               </a>
            </div>
            <ul class="nav navbar-nav">
               <li class="active"><a href="#">Home</a></li>
               <li><a href="https://chaddon.herokuapp.com/lobby">Lobby</a></li>
            </ul>
            <form class="navbar-form navbar-left" action="/action_page.php">
               <div class="form-group">
                  <input type="text" class="form-control" placeholder="Find a channel..." name="search">
               </div>
               <button type="submit" class="btn btn-default">Search</button>
            </form>
         </div>
      </nav>
      <div class="row">
         <div class="col-sm-10">
            <div id="livechat" class="well" ></div>
         </div>
         <div class="users_online col-sm-2">
            <h4>Online</h4>
            <ul id="online"></ul>
         </div>
      </div>
      <nav class="navbar navbar-inverse navbar-fixed-bottom">
         <div class="container-fluid">
				
            <form class="navbar-form">
			   <label id="usernameLabel" class="col-2 col-form-label">Please Sign In, <a class="brand"></a></label>
			   <div id="googleSignIn" style="display: inline-block; margin-left: 10px;"class="g-signin2" data-onsuccess="onSignIn" data-theme="dark"></div>			   			   
			   <input style="display: none;" class="span8" type="text" id="message2" placeholder="Be nice2" style="margin-bottom: 3px;" />
			   <input class="span8" type="text" id="message" placeholder="Be nice" style="margin-bottom: 3px;" />
			   
               <input style="display: none;" class="btn btn-primary span2" type="button" id="send" value="Send" />
            </form>
         </div>
         </div>
      </nav>
      <!-- Including Bootstrap JS (with its jQuery dependency) so that dynamic components work -->
      <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
      <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
      <script src="/socket.io/socket.io.js"></script>
      <script>
		 var user = null;
		 var userProf;
		 
		 function onSignIn(googleUser) {
		    // Useful data for your client-side scripts:
			var profile = googleUser.getBasicProfile();
			console.log("ID: " + profile.getId()); // Don't send this directly to your server!
			console.log('Full Name: ' + profile.getName());					
			// The ID token you need to pass to your backend:
			var id_token = googleUser.getAuthResponse().id_token;
			//console.log("ID Token: " + id_token);
			sessionStorage.username = profile.getName();
			userProf = profile.getName();
			$("#usernameLabel").text("Welcome, " + profile.getName());
			$("#message").show();
			$("#googleSignIn").hide();
			$("#send").show();
		 };

         $(function () {
         	var socket = io.connect(document.location.origin);
         	socket.on('news', function (data) {
         		console.log(data);
         	});
         	
         	//check weather username is stored in the session, if yes then directly authenticate the user
         	if(sessionStorage.username != undefined){
				 console.info("user session undefined");
         		$('#username').hide(sessionStorage.username);
         		$('.brand').html();
         		$('.brand').show();
         		$("#message").show();
         		$("#message").focus();
         		socket.emit('adduser', sessionStorage.username);
         	}
         	else {
         		//hiding the brand
         		$('.brand').hide();
         		$('#message').hide();
         		$("#username").focus();
         	}	
         
         	function addUser() {
         		if(userProf != ""){
         			var usr = userProf;
         			var safe = usr.replace(/&/g, '&amp;').replace(/</g, '&lt;')
         			.replace(/>/g, '&gt;').replace(/"/g, '&quot;');
         			sessionStorage.username = safe;
         			socket.emit('adduser', sessionStorage.username);
         		}
         		return;
         	}
         
         	$("#send").click(function() {
         		console.log("Send pressed");
         		//check if username is null if yes then fire addUsername event and send the username
         		if(sessionStorage.username === undefined){
         			addUser();
         			return;
         		}
         		//handle message send
         		var msg = $('#message').val();
         		if(msg != ""){
         			var safe = msg.replace(/&/g, '&amp;').replace(/</g, '&lt;')
         			.replace(/>/g, '&gt;').replace(/"/g, '&quot;');
         			console.log("message is not null");
         			socket.emit('message', {message: safe, user: sessionStorage.username, timestamp: new Date()}); 
				 }
				 document.getElementById("message").value = "";
         	});
         
         	//handle enter key event on messagebox
         	$("#message").keydown(function (e) {
         		if(e.which === 13){
         			//handle message send
         			var msg = $('#message').val();
         			$('#message').val('');
         			if(msg != ""){
         				var safe = msg.replace(/&/g, '&amp;').replace(/</g, '&lt;')
         				.replace(/>/g, '&gt;').replace(/"/g, '&quot;');
         				console.log("message is not null");
         				socket.emit('message', {message: safe, user: user, timestamp: new Date()}); 
         			}
         		}
         	});
         
         	socket.on('userAdded', function(data) {
         		//add banner containing the username
         		$('#username').hide();
         		$('.brand').html(data.username);
         		$('.brand').show();
         		$("#message").show();
         		$("#message").focus();
         		user = data.username;
         	});
         
         	socket.on('updateUsers', function (data) {
         		if(data != null){
         			$('#online').html("");
         			for(var key in data.usernames){
         				//add the user to the list of online users
         				$('#online').append("<li>"+key+"</li>");
         			}
         		}
         	}); 
         
         	//load history
         	socket.on('loadHistory', function(data) {
         
         		for(var i=0; i<data.length; i++){
         			var html = "<div class='post-other'> <div class='post-inner'><b>"
         			+ data[i].user + "</b> "+ data[i].message + "</div></div>";
         			$('#livechat').append(html);
         		}
         	});
         
         	socket.on('update',function (data) {
         		console.log("updatechat called");
         		var postClass;
         		if(data.user === user){
         			postClass = "post-current";
         		} else {
         			postClass = "post-other";
         		}
         		var html = "<div class='" + postClass + "'> <div class='post-inner'><b>"
         		+ data.user + "</b> " + data.message + "</div></div>";
         		$('#livechat').append(html);
         		$("html, body").animate({ scrollTop: $(document).height() }, "slow");
         	});
         });
      </script>
   </body>
</html>